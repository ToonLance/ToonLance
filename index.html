<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freelance Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .hidden { display: none; }
        .job-card { transition: transform 0.2s; }
        .job-card:hover { transform: scale(1.02); }
        .fade-in { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <nav class="bg-blue-600 text-white p-4 sticky top-0 z-10">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">Freelance Platform</h1>
            <div id="nav-links">
                <a href="#" id="home-link" class="px-4">Home</a>
                <a href="#" id="dashboard-link" class="px-4 hidden">Dashboard</a>
                <a href="#" id="logout-link" class="px-4 hidden">Logout</a>
                <a href="#" id="login-link" class="px-4">Login with Google</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto mt-8 px-4">
        <!-- Job Posting Section -->
        <div id="job-post-section" class="hidden mb-8">
            <div class="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow">
                <h2 class="text-2xl font-bold mb-4">Post a Job</h2>
                <div class="space-y-4">
                    <input id="job-title" type="text" class="w-full p-2 border rounded" placeholder="Job Title" required>
                    <textarea id="job-description" class="w-full p-2 border rounded" placeholder="Job Description" required></textarea>
                    <input id="job-budget" type="number" class="w-full p-2 border rounded" placeholder="Budget ($)" required>
                    <input id="job-skills" type="text" class="w-full p-2 border rounded" placeholder="Skills (comma-separated)">
                    <button id="post-job-btn" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Post Job</button>
                </div>
            </div>
        </div>

        <!-- Bid Submission Section -->
        <div id="bid-section" class="hidden mb-8">
            <div class="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow">
                <h2 class="text-2xl font-bold mb-4">Place a Bid</h2>
                <div class="space-y-4">
                    <input id="bid-amount" type="number" class="w-full p-2 border rounded" placeholder="Bid Amount ($)" required>
                    <textarea id="bid-proposal" class="w-full p-2 border rounded" placeholder="Your Proposal" required></textarea>
                    <button id="submit-bid-btn" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700">Submit Bid</button>
                </div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard-section" class="hidden mb-8">
            <h2 class="text-2xl font-bold mb-4">Your Dashboard</h2>
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-xl font-semibold mb-2">Your Jobs</h3>
                <div id="user-jobs" class="space-y-4"></div>
                <h3 class="text-xl font-semibold mt-6 mb-2">Your Bids</h3>
                <div id="user-bids" class="space-y-4"></div>
            </div>
        </div>

        <!-- Jobs Section -->
        <div id="jobs-section">
            <h2 class="text-2xl font-bold mb-4">Available Jobs</h2>
            <div id="jobs-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA1YGFbDHDuSQVXFsRO-XD7Usir9dULoEU",
    authDomain: "testing-dba79.firebaseapp.com",
    projectId: "testing-dba79",
    storageBucket: "testing-dba79.firebasestorage.app",
    messagingSenderId: "808371260131",
    appId: "1:808371260131:web:a59f409f532e617cba13d6"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM Elements
        const navLinks = document.getElementById('nav-links');
        const loginLink = document.getElementById('login-link');
        const logoutLink = document.getElementById('logout-link');
        const dashboardLink = document.getElementById('dashboard-link');
        const jobPostSection = document.getElementById('job-post-section');
        const bidSection = document.getElementById('bid-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const jobsSection = document.getElementById('jobs-section');
        const jobsList = document.getElementById('jobs-list');
        const userJobs = document.getElementById('user-jobs');
        const userBids = document.getElementById('user-bids');
        const postJobBtn = document.getElementById('post-job-btn');
        const submitBidBtn = document.getElementById('submit-bid-btn');

        let currentUser = null;
        let currentJobId = null;

        // Google Auth Provider
        const provider = new firebase.auth.GoogleAuthProvider();

        // Authentication State Listener
        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                loginLink.classList.add('hidden');
                logoutLink.classList.remove('hidden');
                dashboardLink.classList.remove('hidden');
                jobPostSection.classList.remove('hidden');
                updateUserProfile(user);
                loadUserData();
            } else {
                loginLink.classList.remove('hidden');
                logoutLink.classList.add('hidden');
                dashboardLink.classList.add('hidden');
                jobPostSection.classList.add('hidden');
                bidSection.classList.add('hidden');
                dashboardSection.classList.add('hidden');
                jobsSection.classList.remove('hidden');
            }
            loadJobs();
        });

        // Update User Profile in Firestore
        async function updateUserProfile(user) {
            const userRef = db.collection('users').doc(user.uid);
            await userRef.set({
                email: user.email,
                displayName: user.displayName,
                photoURL: user.photoURL,
                role: 'freelancer', // Default role, can be updated via UI
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
        }

        // Google Login
        loginLink.addEventListener('click', async e => {
            e.preventDefault();
            try {
                await auth.signInWithPopup(provider);
            } catch (error) {
                console.error('Login error:', error);
                alert('Failed to login: ' + error.message);
            }
        });

        // Logout
        logoutLink.addEventListener('click', async e => {
            e.preventDefault();
            try {
                await auth.signOut();
                alert('Logged out successfully');
            } catch (error) {
                console.error('Logout error:', error);
                alert('Failed to logout: ' + error.message);
            }
        });

        // Load Available Jobs
        async function loadJobs() {
            jobsList.innerHTML = '<p class="text-center">Loading...</p>';
            try {
                const snapshot = await db.collection('jobs')
                    .where('status', '==', 'open')
                    .orderBy('createdAt', 'desc')
                    .get();
                jobsList.innerHTML = '';
                snapshot.forEach(doc => {
                    const job = { id: doc.id, ...doc.data() };
                    const jobCard = document.createElement('div');
                    jobCard.className = 'job-card bg-white p-4 rounded-lg shadow fade-in';
                    jobCard.innerHTML = `
                        <h3 class="text-lg font-semibold">${job.title}</h3>
                        <p class="text-gray-600">${job.description.substring(0, 100)}...</p>
                        <p class="text-blue-600 font-bold">Budget: $${job.budget}</p>
                        <p class="text-sm text-gray-500">Skills: ${job.skills.join(', ')}</p>
                        <p class="text-sm text-gray-500">Posted by: ${job.clientName}</p>
                        <button class="mt-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 view-bids-btn" data-jobid="${job.id}">
                            View Bids
                        </button>
                        ${currentUser && currentUser.uid !== job.clientId ? 
                            `<button class="mt-2 ml-2 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 place-bid-btn" data-jobid="${job.id}">
                                Place Bid
                            </button>` : ''}
                    `;
                    jobsList.appendChild(jobCard);
                });

                // Add event listeners for bid buttons
                document.querySelectorAll('.place-bid-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        currentJobId = btn.dataset.jobid;
                        bidSection.classList.remove('hidden');
                        jobsSection.classList.add('hidden');
                    });
                });

                // Add event listeners for view bids buttons
                document.querySelectorAll('.view-bids-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const jobId = btn.dataset.jobid;
                        await loadBids(jobId);
                    });
                });
            } catch (error) {
                console.error('Error loading jobs:', error);
                jobsList.innerHTML = '<p class="text-center text-red-500">Error loading jobs</p>';
            }
        }

        // Load Bids for a Job
        async function loadBids(jobId) {
            jobsList.innerHTML = '<p class="text-center">Loading bids...</p>';
            try {
                const snapshot = await db.collection('bids')
                    .where('jobId', '==', jobId)
                    .orderBy('createdAt', 'desc')
                    .get();
                jobsList.innerHTML = '<button class="mb-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 back-to-jobs">Back to Jobs</button>';
                snapshot.forEach(doc => {
                    const bid = { id: doc.id, ...doc.data() };
                    const bidCard = document.createElement('div');
                    bidCard.className = 'bg-white p-4 rounded-lg shadow fade-in';
                    bidCard.innerHTML = `
                        <p><strong>Bidder:</strong> ${bid.freelancerName}</p>
                        <p><strong>Amount:</strong> $${bid.amount}</p>
                        <p><strong>Proposal:</strong> ${bid.proposal}</p>
                        <p><strong>Status:</strong> ${bid.status}</p>
                    `;
                    jobsList.appendChild(bidCard);
                });
                document.querySelector('.back-to-jobs').addEventListener('click', loadJobs);
            } catch (error) {
                console.error('Error loading bids:', error);
                jobsList.innerHTML = '<p class="text-center text-red-500">Error loading bids</p>';
            }
        }

        // Post a Job
        postJobBtn.addEventListener('click', async () => {
            if (!currentUser) return alert('Please login to post a job');
            const title = document.getElementById('job-title').value;
            const description = document.getElementById('job-description').value;
            const budget = parseFloat(document.getElementById('job-budget').value);
            const skills = document.getElementById('job-skills').value.split(',').map(s => s.trim()).filter(s => s);
            
            if (!title || !description || !budget) {
                return alert('Please fill all required fields');
            }

            try {
                await db.collection('jobs').add({
                    title,
                    description,
                    budget,
                    skills,
                    clientId: currentUser.uid,
                    clientName: currentUser.displayName || currentUser.email,
                    status: 'open',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('Job posted successfully');
                document.getElementById('job-title').value = '';
                document.getElementById('job-description').value = '';
                document.getElementById('job-budget').value = '';
                document.getElementById('job-skills').value = '';
                loadJobs();
            } catch (error) {
                console.error('Error posting job:', error);
                alert('Failed to post job: ' + error.message);
            }
        });

        // Submit a Bid
        submitBidBtn.addEventListener('click', async () => {
            if (!currentUser) return alert('Please login to place a bid');
            const amount = parseFloat(document.getElementById('bid-amount').value);
            const proposal = document.getElementById('bid-proposal').value;

            if (!amount || !proposal) {
                return alert('Please fill all required fields');
            }

            try {
                await db.collection('bids').add({
                    jobId: currentJobId,
                    freelancerId: currentUser.uid,
                    freelancerName: currentUser.displayName || currentUser.email,
                    amount,
                    proposal,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('Bid placed successfully');
                document.getElementById('bid-amount').value = '';
                document.getElementById('bid-proposal').value = '';
                bidSection.classList.add('hidden');
                jobsSection.classList.remove('hidden');
                loadJobs();
            } catch (error) {
                console.error('Error placing bid:', error);
                alert('Failed to place bid: ' + error.message);
            }
        });

        // Load User Data (Dashboard)
        async function loadUserData() {
            if (!currentUser) return;
            try {
                // Load user's jobs
                userJobs.innerHTML = '<p>Loading...</p>';
                const jobSnapshot = await db.collection('jobs')
                    .where('clientId', '==', currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .get();
                userJobs.innerHTML = '';
                jobSnapshot.forEach(doc => {
                    const job = { id: doc.id, ...doc.data() };
                    const jobCard = document.createElement('div');
                    jobCard.className = 'bg-gray-50 p-4 rounded-lg';
                    jobCard.innerHTML = `
                        <h4 class="font-semibold">${job.title}</h4>
                        <p>Budget: $${job.budget}</p>
                        <p>Status: ${job.status}</p>
                    `;
                    userJobs.appendChild(jobCard);
                });

                // Load user's bids
                userBids.innerHTML = '<p>Loading...</p>';
                const bidSnapshot = await db.collection('bids')
                    .where('freelancerId', '==', currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .get();
                userBids.innerHTML = '';
                bidSnapshot.forEach(doc => {
                    const bid = { id: doc.id, ...doc.data() };
                    const bidCard = document.createElement('div');
                    bidCard.className = 'bg-gray-50 p-4 rounded-lg';
                    bidCard.innerHTML = `
                        <p><strong>Job ID:</strong> ${bid.jobId}</p>
                        <p><strong>Amount:</strong> $${bid.amount}</p>
                        <p><strong>Status:</strong> ${bid.status}</p>
                    `;
                    userBids.appendChild(bidCard);
                });
            } catch (error) {
                console.error('Error loading user data:', error);
                userJobs.innerHTML = '<p class="text-red-500">Error loading jobs</p>';
                userBids.innerHTML = '<p class="text-red-500">Error loading bids</p>';
            }
        }

        // Dashboard Link
        dashboardLink.addEventListener('click', e => {
            e.preventDefault();
            dashboardSection.classList.remove('hidden');
            jobsSection.classList.add('hidden');
            bidSection.classList.add('hidden');
            loadUserData();
        });

        // Home Link
        document.getElementById('home-link').addEventListener('click', e => {
            e.preventDefault();
            dashboardSection.classList.add('hidden');
            jobsSection.classList.remove('hidden');
            bidSection.classList.add('hidden');
            loadJobs();
        });
    </script>
</body>
</html>